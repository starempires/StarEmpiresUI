# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
# Development (requires AWS credentials)
npx ampx sandbox      # Terminal 1: start cloud backend sandbox (watches amplify/ for changes)
npm run dev           # Terminal 2: start Vite dev server at https://localhost:5173

# Build & lint
npm run build         # tsc + vite build
npm run lint          # ESLint (zero warnings allowed)

# Tests
npm test              # run all tests once
npm run test:watch    # run tests in watch mode
npm run test:ui       # run tests with Vitest UI dashboard

# Run a single test file
npx vitest --run tests/components/panels/OrdersPane.test.tsx
```

The dev server uses HTTPS (`localhost.pem` / `localhost-key.pem` in the project root). `amplify_outputs.json` must exist before starting the frontend — it is generated by the sandbox or a prior deployment.

## Architecture

Star Empires UI is a React SPA (React 19, React Router v7, MUI v7) for a turn-based space strategy game. The backend is AWS Amplify Gen 2 (Cognito auth, AppSync/GraphQL data layer, Lambda resolvers).

### Entry point and auth flow

`index.html` → `src/main.jsx` configures Amplify from `amplify_outputs.json`, then renders `App.tsx` inside `<Authenticator>`. `App.tsx` fetches the user's Cognito groups, stores them in state, and calls `amplify/players.ts:ensurePlayerExists()` to upsert the Player record on first login.

### Routing and access control (`src/App.tsx`)

Three protection modes via `ProtectedRoute`:
- Default — authentication required
- `requiresEmpireAccess={true}` — user must own the empire in the URL params (validated by `AuthorizationService`)
- `staticPage={true}` — authentication only, no empire check

Empire-specific routes carry `/:sessionName/:empireName/:turnNumber` params. The ADMINS and GAMEMASTERS Cognito groups unlock admin features (e.g. `/create-session/`).

### Shared galaxy state (`SnapshotContext`)

`SnapshotContext` (in `src/components/common/`) is the React context that holds the current turn snapshot fetched from AppSync. It is provided at the `App` level and consumed by `MapPage` and its children. Avoid prop-drilling the snapshot data.

### Galaxy map rendering (`src/components/galaxy/`)

The map is a Konva canvas (`react-konva`). Key rendering hierarchy:

- `Galaxy` — top-level Konva Stage; composes layers for sectors, connections, and UI overlays
- `Sector` — renders a single hex sector (background fill by scan status, world circle, ship dots, prohibition overlays)
- `Connections` — renders warp-lane lines and portal markers between sectors
- Hex math lives in `src/Constants.ts` (`coordsToPosition()`, `getXCount()`, `getCoordinateKey()`). The hex grid uses a flat-top orientation with `RADIUS = 50`.

All canvas constants (colors, sizes, fonts) are exported from `src/Constants.ts`. Enums are defined as `const` objects with literal types (e.g. `SCAN_STATUS_TYPE`, `BORDER_TYPE`, `PROHIBITION_TYPE`).

### Backend definitions (`amplify/`)

- `amplify/auth/resource.ts` — Cognito user pool (groups: ADMINS, GAMEMASTERS)
- `amplify/data/resource.ts` — GraphQL schema: Player, Session, Empire, Message, MessageRecipient
- `amplify/backend.ts` — composes auth + data
- `amplify/players.ts` — Lambda-side helper imported by the frontend to upsert Player records

Changing files under `amplify/` triggers automatic resource updates in the running sandbox.

### Services and hooks

- `AuthorizationService` / `useAuthorization` hook — validates empire ownership against the current user's session
- `GrammarService` + `src/grammar/` — parses and validates in-game order strings entered in the orders pane
- `OverlayContentGenerator` / `OverlayContextAnalyzer` — generate tooltip/overlay content for clicked sectors
- `ErrorLoggingService` — centralized error logging with context; use this instead of bare `console.error`

### Testing conventions

Tests live in `tests/` mirroring the `src/` structure. `tests/setupTests.js` mocks Amplify config and Cognito/GraphQL clients — all tests run without real AWS credentials.

Property-based tests use `fast-check` (see `ClientFunctions.test.ts` for examples). Session-persistence behaviour is tested separately in `*.sessionPersistence.test.tsx` files.
